# AWS S3 Setup Guide

This guide will help you set up AWS S3 for storing book files (EPUB) and cover images.

## Prerequisites

1. An AWS account (sign up at [aws.amazon.com](https://aws.amazon.com))
2. AWS CLI installed (optional, for easier setup)

---

## Step 1: Create an S3 Bucket

### Option A: Using AWS Console (Recommended)

1. Log in to [AWS Console](https://console.aws.amazon.com)
2. Navigate to **S3** service
3. Click **Create bucket**
4. Configure your bucket:
   - **Bucket name**: Choose a unique name (e.g., `ebook-athena-books`)
   - **AWS Region**: Choose a region close to your users (e.g., `us-east-1`)
   - **Object Ownership**: Choose **ACLs disabled** (recommended) or **ACLs enabled** (if you need public access)
   - **Block Public Access**: 
     - For public files: Uncheck all (allows public read access)
     - For private files: Keep checked (files will be private)
   - **Bucket Versioning**: Disable (unless you need versioning)
   - **Default encryption**: Enable (recommended)
5. Click **Create bucket**

### Option B: Using AWS CLI

```bash
aws s3 mb s3://ebook-athena-books --region us-east-1
```

---

## Step 2: Configure Bucket Permissions

### For Public Access (Recommended for Covers)

If you want cover images to be publicly accessible:

1. Go to your bucket â†’ **Permissions** tab
2. Under **Block public access**, click **Edit**
3. Uncheck **Block all public access** (or uncheck specific options)
4. Save changes
5. Add a bucket policy:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "PublicReadGetObject",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::ebook-athena-books/covers/*"
    }
  ]
}
```

**Note:** Replace `ebook-athena-books` with your bucket name.

### For Private Access (Recommended for Book Files)

Keep files private and use presigned URLs for access:

1. Keep **Block public access** enabled
2. Files will be accessible only via presigned URLs (generated by the API)

---

## Step 3: Create IAM User and Access Keys

1. Go to **IAM** service in AWS Console
2. Click **Users** â†’ **Create user**
3. Enter username: `ebook-athena-s3-user`
4. Click **Next**
5. **Attach policies directly**:
   - Search and select: `AmazonS3FullAccess` (for full access)
   - OR create a custom policy with limited permissions (see below)
6. Click **Next** â†’ **Create user**

### Custom IAM Policy (Recommended for Production)

For better security, create a custom policy with only necessary permissions:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:DeleteObject"
      ],
      "Resource": "arn:aws:s3:::ebook-athena-books/*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:ListBucket"
      ],
      "Resource": "arn:aws:s3:::ebook-athena-books"
    }
  ]
}
```

### Create Access Keys

1. Click on the created user
2. Go to **Security credentials** tab
3. Click **Create access key**
4. Choose **Application running outside AWS**
5. Click **Next** â†’ **Create access key**
6. **IMPORTANT:** Copy both:
   - **Access key ID**
   - **Secret access key** (you won't see it again!)

---

## Step 4: Configure Environment Variables

Add the following to your `backend/.env` file:

```env
# AWS S3 Configuration
AWS_ACCESS_KEY_ID=your_access_key_id_here
AWS_SECRET_ACCESS_KEY=your_secret_access_key_here
AWS_REGION=us-east-1
AWS_S3_BUCKET_NAME=ebook-athena-books
```

### Environment Variables Explained

- **AWS_ACCESS_KEY_ID**: Your IAM user's access key ID
- **AWS_SECRET_ACCESS_KEY**: Your IAM user's secret access key
- **AWS_REGION**: The AWS region where your bucket is located (e.g., `us-east-1`, `eu-west-1`)
- **AWS_S3_BUCKET_NAME**: Your S3 bucket name

---

## Step 5: Test the Setup

### Test Upload Endpoint

1. Start your backend server
2. Login as Admin
3. Use the upload endpoint:

```bash
POST http://localhost:5000/api/books/upload
Authorization: Bearer <admin_token>
Content-Type: multipart/form-data

Form Data:
- title: "Test Book"
- author: "Test Author"
- price: 9.99
- epub: [select EPUB file]
- cover: [select image file] (optional)
```

### Verify Files in S3

1. Go to your S3 bucket in AWS Console
2. Check the `books/` and `covers/` folders
3. Verify files are uploaded correctly

---

## File Structure in S3

Your S3 bucket will have the following structure, organized by user ID:

```
ebook-athena-books/
â””â”€â”€ users/
    â”œâ”€â”€ 550e8400-e29b-41d4-a716-446655440000/
    â”‚   â”œâ”€â”€ books/
    â”‚   â”‚   â”œâ”€â”€ the-great-gatsby_1234567890_abc123.epub
    â”‚   â”‚   â””â”€â”€ tender-is-the-night_1234567891_def456.epub
    â”‚   â””â”€â”€ covers/
    â”‚       â”œâ”€â”€ the-great-gatsby_1234567890_xyz789.jpg
    â”‚       â””â”€â”€ tender-is-the-night_1234567891_uvw012.jpg
    â”œâ”€â”€ 660e8400-e29b-41d4-a716-446655440001/
    â”‚   â”œâ”€â”€ books/
    â”‚   â”‚   â””â”€â”€ harry-potter_1234567892_ghi789.epub
    â”‚   â””â”€â”€ covers/
    â”‚       â””â”€â”€ harry-potter_1234567892_jkl012.jpg
    â””â”€â”€ 770e8400-e29b-41d4-a716-446655440002/
        â”œâ”€â”€ books/
        â”‚   â””â”€â”€ game-of-thrones_1234567893_mno345.epub
        â””â”€â”€ covers/
            â””â”€â”€ game-of-thrones_1234567893_pqr678.jpg
```

**Note:** 
- Each user gets their own folder using their unique user ID (UUID)
- Within each user folder, there are `books/` and `covers/` subfolders
- All books uploaded by the same user go into their user ID folder
- This makes it easy to fetch all files for a specific user
- User IDs are UUIDs, so they're unique and consistent

---

## File Size Limits

- **Cover Images**: Maximum 5MB
- **Book Files (EPUB)**: Maximum 50MB

These limits are configured in `backend/middleware/upload.js` and can be adjusted if needed.

---

## Allowed File Types

### Cover Images
- JPEG/JPG (`image/jpeg`)
- PNG (`image/png`)
- WebP (`image/webp`)

### Book Files
- EPUB (`application/epub+zip`)

---

## Security Best Practices

1. **Never commit `.env` file** - Keep your AWS credentials secure
2. **Use IAM roles in production** - Instead of access keys when possible
3. **Limit IAM permissions** - Use custom policies with minimal required permissions
4. **Enable bucket encryption** - Protect files at rest
5. **Use presigned URLs** - For private book files instead of public access
6. **Enable CloudFront** - For better performance and CDN capabilities (optional)

---

## Troubleshooting

### Error: "AWS_S3_BUCKET_NAME is not configured"
- Make sure all AWS environment variables are set in `.env`
- Restart your server after adding environment variables

### Error: "Access Denied"
- Check IAM user permissions
- Verify access keys are correct
- Ensure bucket name is correct

### Error: "The specified bucket does not exist"
- Verify bucket name in `.env` matches your actual bucket name
- Check AWS region is correct

### Files not accessible publicly
- Check bucket's Block Public Access settings
- Verify bucket policy allows public read access (if needed)
- For private files, use presigned URLs

---

## Cost Considerations

AWS S3 pricing (as of 2024):
- **Storage**: ~$0.023 per GB/month
- **PUT requests**: ~$0.005 per 1,000 requests
- **GET requests**: ~$0.0004 per 1,000 requests
- **Data transfer out**: First 1GB free, then ~$0.09 per GB

**Example monthly cost for 1000 books (avg 5MB each):**
- Storage: ~$0.12/month
- Uploads: ~$0.005 per 1000 uploads
- Downloads: ~$0.0004 per 1000 downloads

---

## Next Steps

1. âœ… S3 bucket created
2. âœ… IAM user and access keys configured
3. âœ… Environment variables set
4. âœ… Test upload endpoint
5. ðŸ”„ (Optional) Set up CloudFront CDN for better performance
6. ðŸ”„ (Optional) Set up S3 lifecycle policies for old files
7. ðŸ”„ (Optional) Enable S3 versioning for backup

---

## Additional Resources

- [AWS S3 Documentation](https://docs.aws.amazon.com/s3/)
- [AWS IAM Best Practices](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html)
- [S3 Pricing Calculator](https://calculator.aws/)

---

**Your S3 setup is complete! ðŸŽ‰**

You can now upload books and cover images through the API.

